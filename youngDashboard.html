<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caregiver Dashboard: Dr. Arthur Jenkins</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        /* Custom styles for high legibility and large touch targets */
        :root {
            --primary: #4338ca; /* Darker Indigo */
            --secondary: #059669; /* Darker Emerald */
            --danger: #dc2626; /* Stronger Red */
            --warning: #fbbf24; /* Amber */
            --background: #f7f8fc; /* Soft Light Grey Background */
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            line-height: 1.4;
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid #e5e7eb;
            box-shadow: 0 8px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 20px -3px rgba(0, 0, 0, 0.1), 0 6px 8px -4px rgba(0, 0, 0, 0.1);
        }

        .alert-card {
            background-color: #fef2f2; /* Light red background */
            border-left: 6px solid var(--danger);
        }
        
        .safe-status {
            color: var(--secondary);
        }
        .caution-status {
            color: var(--warning);
        }
        .critical-status {
            color: var(--danger);
        }
        .progress-safe { background-color: var(--secondary); }
        .progress-caution { background-color: var(--warning); }
        .progress-critical { background-color: var(--danger); }

        /* Large font sizes for clarity */
        .value-large {
            font-size: 3rem; /* 48px */
            line-height: 1;
        }
        .metric-label {
            font-size: 1.125rem; /* 18px */
            font-weight: 500;
        }
        
        /* Custom Task Item styles */
        .task-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            cursor: pointer;
            transition: background-color 0.1s;
        }
        .task-item:hover {
            background-color: #f9fafb;
        }
        .task-item.completed span {
            text-decoration: line-through;
            color: #9ca3af; /* Gray text for completed items */
        }
        
        @media (max-width: 640px) {
            .value-large {
                font-size: 2.25rem;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Header and User Status -->
    <header class="mb-8 border-b pb-4">
        <h1 class="text-4xl md:text-5xl font-extrabold text-gray-800 tracking-tight mb-2">
            Remote Caregiver Dashboard
        </h1>
        <p class="text-xl text-gray-600">
            Monitoring **Dr. Arthur Jenkins** | Last Update: <span id="last-update" class="font-semibold text-gray-800">Just now</span>
        </p>
    </header>

    <!-- Main Grid Layout -->
    <main class="grid grid-cols-1 lg:grid-cols-4 gap-6">

        <!-- Column 1: Priority Alerts & Task Management -->
        <div class="lg:col-span-1 space-y-6">

            <h2 class="text-2xl font-bold text-gray-700">Priority Alerts</h2>

            <!-- Urgent Alert Card -->
            <div id="urgent-alert" class="card alert-card p-6 rounded-xl hidden">
                <div class="flex items-center space-x-3 mb-2">
                    <!-- Icon for Critical Alert -->
                    <svg class="w-8 h-8 critical-status" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    <h3 class="text-2xl font-bold critical-status">CRITICAL ALERT</h3>
                </div>
                <p class="text-lg text-gray-700 font-medium" id="alert-message">Abnormal drop in SpO₂ detected. Please check user immediately.</p>
                <button onclick="showModalMessage('Alert Acknowledged', 'Thank you. We have recorded that you have seen this alert. Emergency services were not contacted.')" class="mt-4 w-full bg-danger hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                    Acknowledge Alert
                </button>
            </div>

            <!-- Safety Summary Card -->
            <div class="card p-6 rounded-xl">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Safety Summary</h3>
                <div class="space-y-4">
                    <!-- Safety Metric 1: Gait Risk Score (Now with Progress Bar) -->
                    <div class="border-b pb-4">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-gray-600 metric-label">Balance Risk Score (0-100)</span>
                            <span id="gait-risk" class="text-3xl font-bold caution-status">68</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div id="gait-risk-bar" class="h-2.5 rounded-full" style="width: 68%;"></div>
                        </div>
                         <p class="text-xs text-gray-500 mt-1" id="gait-risk-label">Current: Moderate Risk</p>
                    </div>
                    <!-- Safety Metric 2: Device Adherence -->
                    <div class="flex justify-between items-center border-b pb-2">
                        <span class="text-gray-600 metric-label">Daily Device Adherence</span>
                        <span id="adherence-time" class="text-3xl font-bold safe-status">92%</span>
                    </div>
                    <!-- Safety Metric 3: Fall Status -->
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600 metric-label">Last Fall Event</span>
                        <span id="fall-status" class="text-lg font-semibold text-gray-500">None in 30 days</span>
                    </div>
                </div>
            </div>
            
            <!-- Daily Task Checklist Card -->
            <div class="card p-6 rounded-xl">
                <h3 class="text-xl font-semibold text-gray-800 mb-4 flex justify-between items-center">
                    Daily Task Checklist
                    <span id="task-count" class="text-sm font-medium text-gray-500">2/5 Done</span>
                </h3>

                <!-- Task List -->
                <div id="task-list" class="divide-y divide-gray-100 mb-4">
                    <!-- Tasks will be inserted here by JavaScript -->
                </div>

                <!-- Add New Task Form -->
                <form id="add-task-form" class="mt-4 flex space-x-2">
                    <input type="text" id="new-task-input" placeholder="Add a new task (e.g., Take medication)" 
                           class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150 text-base" required>
                    <button type="submit" class="bg-primary hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 text-base flex-shrink-0">
                        Add
                    </button>
                </form>
            </div>

        </div>

        <!-- Column 2-4: Key Trends and Vitals (Data Section) -->
        <div class="lg:col-span-3 space-y-6">
            
            <!-- Vitals Snapshot (MOVED TO TOP) -->
            <h2 class="text-2xl font-bold text-gray-700">Latest Vitals Snapshot & Health Overview</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                
                <!-- VITAL 1: Heart Rate (HR) -->
                <div class="card p-5 rounded-xl text-center cursor-pointer hover:bg-gray-50" onclick="showTrendDetail('hr')">
                    <p class="text-base text-gray-500 font-medium uppercase mb-2">Heart Rate (BPM)</p>
                    <div class="value-large font-bold" id="hr-value">72</div>
                    <p class="text-sm text-gray-500 mt-1 safe-status" id="hr-status">Stable</p>
                    <p class="text-xs text-gray-400 mt-2">Significance: Measures cardiac health and stress. A low resting HR is often good, but sudden drops or peaks can signal issues.</p>
                </div>
                
                <!-- VITAL 2: Blood Oxygen (SpO₂) -->
                <div class="card p-5 rounded-xl text-center cursor-pointer hover:bg-gray-50" onclick="showTrendDetail('spo2')">
                    <p class="text-base text-gray-500 font-medium uppercase mb-2">Blood Oxygen (SpO₂)</p>
                    <div class="value-large font-bold" id="spo2-value">98%</div>
                    <p class="text-sm text-gray-500 mt-1 safe-status" id="spo2-status">Optimal</p>
                    <p class="text-xs text-gray-400 mt-2">Significance: Measures oxygen saturation. Crucial for respiratory health; values below 94% usually warrant attention.</p>
                </div>
                
                <!-- VITAL 3: Activity Today (Steps) -->
                <div class="card p-5 rounded-xl text-center cursor-pointer hover:bg-gray-50" onclick="showTrendDetail('steps')">
                    <p class="text-base text-gray-500 font-medium uppercase mb-2">Steps Today</p>
                    <div class="value-large font-bold text-primary" id="steps-value">1,540</div>
                    <p class="text-sm text-gray-500 mt-1" id="steps-status">Moderate activity</p>
                    <p class="text-xs text-gray-400 mt-2">Significance: Daily movement indicates mobility and energy. Consistent, low step counts suggest fatigue or reluctance to move.</p>
                </div>
                
                 <!-- VITAL 4: Sleep Duration -->
                <div class="card p-5 rounded-xl text-center cursor-pointer hover:bg-gray-50" onclick="showTrendDetail('sleep')">
                    <p class="text-base text-gray-500 font-medium uppercase mb-2">Last Sleep Duration</p>
                    <div class="value-large font-bold text-primary" id="sleep-value">7.2h</div>
                    <p class="text-sm text-gray-500 mt-1 safe-status" id="sleep-status">Good quality</p>
                    <p class="text-xs text-gray-400 mt-2">Significance: Poor sleep affects cognition, mood, and immune function. Tracking consistency and duration is key for recovery.</p>
                </div>
            </div> <!-- End of Vitals Snapshot -->

            <!-- Health Assessment Summary -->
            <div class="card p-6 rounded-xl">
                <h3 class="text-2xl font-bold text-gray-800 mb-3 flex items-center justify-between">
                    <span class="flex items-center text-primary">
                        <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.414L11 11.586V6z" clip-rule="evenodd"></path></svg>
                        Overall Health Assessment (7-Day View)
                    </span>
                    <button onclick="generateHealthSummary(true)" class="text-sm font-semibold text-gray-500 hover:text-primary transition duration-150 p-2 rounded-lg border border-gray-200 hover:border-primary">
                        Re-analyze
                    </button>
                </h3>
                <!-- The health summary content will be injected here -->
                <div id="health-summary" class="text-gray-700 leading-relaxed"></div>
                <p id="analysis-status" class="text-sm italic text-gray-500 mt-2 hidden">Re-running complex analysis...</p>
            </div>

            <!-- Trend Charts Row (Daily/Weekly Aggregate Charts) -->
            <h2 class="text-2xl font-bold text-gray-700 pt-4">Weekly Aggregate Trends</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                <!-- Chart 1: 7-Day Heart Rate Trend (BPM) -->
                <div class="card p-6 rounded-xl">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">7-Day Heart Rate Trend (BPM)</h3>
                    <div id="hr-chart-container" class="bg-white h-64 flex items-center justify-center rounded-lg">
                        <canvas id="hrChart"></canvas>
                    </div>
                </div>

                <!-- Chart 2: Task Compliance Rate -->
                <div class="card p-6 rounded-xl">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">7-Day Task Compliance Rate (%)</h3>
                    <div id="compliance-chart-container" class="bg-white h-64 flex items-center justify-center rounded-lg">
                        <canvas id="complianceChart"></canvas>
                    </div>
                </div>

            </div>
            
        </div> <!-- End of Data Section -->

    </main>

    <footer class="mt-8 pt-6 border-t border-gray-200 text-center text-sm text-gray-500">
        Guardian Ear Device Project Concept Dashboard | Designed for Caregiver Monitoring
    </footer>

    <!-- JavaScript for Mock Data, Charts, and Interaction -->
    <script>
        // --- Global Variables/Elements ---
        const urgentAlertEl = document.getElementById('urgent-alert');
        const hrValueEl = document.getElementById('hr-value');
        const spo2ValueEl = document.getElementById('spo2-value');
        const lastUpdateEl = document.getElementById('last-update');
        const adherenceTimeEl = document.getElementById('adherence-time');
        const gaitRiskEl = document.getElementById('gait-risk');
        const gaitRiskBarEl = document.getElementById('gait-risk-bar');
        const gaitRiskLabelEl = document.getElementById('gait-risk-label');
        const healthSummaryEl = document.getElementById('health-summary');
        const analysisStatusEl = document.getElementById('analysis-status');
        const taskListEl = document.getElementById('task-list');
        const taskCountEl = document.getElementById('task-count');
        
        // Vitals Status Labels
        const hrStatusEl = document.getElementById('hr-status');
        const spo2StatusEl = document.getElementById('spo2-status');
        const stepsStatusEl = document.getElementById('steps-status');
        const sleepStatusEl = document.getElementById('sleep-status');
        
        let hrChart = null; 
        let complianceChart = null;

        // Mock Data for Dashboard Metrics
        let currentAdherence = 92;
        let currentGaitRisk = 68;
        let currentSpo2 = 98;
        let currentAvgCompliance = 90; // Mock average compliance
        let currentHr = 72;
        let currentSteps = 1540;
        let currentSleep = 7.2;

        // Mock Data for Task List (NEW)
        let tasks = [
            { id: 1, text: "Take Morning Medication (7:00 AM)", completed: true },
            { id: 2, text: "20-minute Light Walk", completed: false },
            { id: 3, text: "Call Daughter (Sarah) at 4 PM", completed: false },
            { id: 4, text: "Check Blood Sugar (Afternoon)", completed: true },
            { id: 5, text: "Evening Eye Drops", completed: false },
        ];


        // --- Utility Functions ---

        /**
         * Function to display a simple modal message (replaces alert()).
         * Includes both a top-right 'X' button and a bottom 'Close' button.
         * @param {string} title - Modal title.
         * @param {string} content - Modal inner HTML content.
         * @param {boolean} isLarge - Use a wider modal for charts.
         */
        function showModalMessage(title, content, isLarge = false) {
            const existingModal = document.getElementById('custom-modal');
            if(existingModal) existingModal.remove();

            const maxWidthClass = isLarge ? 'max-w-4xl' : 'max-w-sm'; // Increased max-width for better chart viewing

            const modalHtml = `
                <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex justify-center items-center">
                    <div class="bg-white p-8 rounded-xl shadow-2xl mx-4 ${maxWidthClass} w-full relative">
                        <!-- Close Button (Top Right) -->
                        <button onclick="document.getElementById('custom-modal').remove()" 
                                class="absolute top-4 right-4 text-gray-400 hover:text-gray-800 transition duration-150 p-2 rounded-full hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-primary">
                            <!-- SVG X Icon -->
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                        
                        <h4 class="text-xl font-bold mb-4 text-gray-800">${title}</h4>
                        <div class="text-gray-700 mb-6" id="modal-content">${content}</div>
                        
                        <!-- Close Button (Bottom) -->
                        <button onclick="document.getElementById('custom-modal').remove()" 
                                class="w-full bg-primary hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        /**
         * Generates a textual summary based on current mock metrics.
         * @param {boolean} isManualRefresh - True if triggered by user click.
         */
        function generateHealthSummary(isManualRefresh = false) {
            if (isManualRefresh) {
                analysisStatusEl.classList.remove('hidden');
                healthSummaryEl.innerHTML = "<p class='animate-pulse text-lg'>Analyzing the latest data using machine learning... Please wait.</p>";
            }
            
            // Simulate API/LLM delay for complex analysis
            setTimeout(() => {
                let primaryStatus = "is **stable and well-managed** over the past week, with all core vitals in safe ranges.";
                let detailedNotes = []; 

                // --- 1. Vital Signs Assessment (HR/SpO2) ---
                if (currentSpo2 < 95) {
                    detailedNotes.push(`<span class="critical-status font-semibold">CRITICAL: Blood Oxygen is low (${currentSpo2}%).</span>`);
                } else if (currentSpo2 < 97) {
                    detailedNotes.push(`Blood Oxygen is stable (${currentSpo2}%), but vigilance is recommended.`);
                } else {
                    detailedNotes.push(`Heart Rate (${currentHr} BPM) and SpO₂ (${currentSpo2}%) are stable and optimal.`);
                }

                // --- 2. Safety Assessment (Gait Risk) ---
                if (currentGaitRisk > 85) {
                    primaryStatus = "shows **elevated safety concerns** due to high Balance Risk (85+).";
                    detailedNotes.push(`Balance Risk is <span class="critical-status font-semibold">CRITICAL (${currentGaitRisk})</span>. Immediate monitoring is required.`);
                } else if (currentGaitRisk > 65) {
                    primaryStatus = "is in a **cautious state** with moderate Balance Risk (65+).";
                    detailedNotes.push(`Balance Risk is <span class="caution-status font-semibold">MODERATE (${currentGaitRisk})</span>, suggesting recent instability.`);
                } else {
                     detailedNotes.push(`Balance Risk is controlled (${currentGaitRisk}), indicating good stability.`);
                }

                // --- 3. Activity and Sleep Assessment ---
                if (currentSteps < 1000) {
                    detailedNotes.push(`<span class="caution-status font-semibold">Activity is low (${currentSteps} steps)</span>. Investigate possible fatigue or reluctance to move.`);
                } else if (currentSteps < 2000) {
                    detailedNotes.push(`Activity is moderate (${currentSteps} steps), maintaining a minimal routine.`);
                } else {
                    detailedNotes.push(`Activity is good (${currentSteps} steps), indicating healthy mobility.`);
                }
                
                if (currentSleep < 6.5) {
                    detailedNotes.push(`<span class="caution-status font-semibold">Sleep duration was poor (${currentSleep} hours)</span>. Monitor for nighttime disturbances.`);
                } else if (currentSleep > 7.5) {
                    detailedNotes.push(`Sleep duration was excellent (${currentSleep} hours), supporting recovery.`);
                } else {
                    detailedNotes.push(`Sleep duration was adequate (${currentSleep} hours).`);
                }
                
                // --- 4. Adherence and Compliance Assessment ---
                if (currentAdherence < 80) {
                    detailedNotes.push(`Device adherence is low (${currentAdherence}%), which compromises data reliability.`);
                } else {
                    detailedNotes.push(`Device adherence remains strong (${currentAdherence}%), ensuring high data quality.`);
                }

                if (currentAvgCompliance < 85) {
                    detailedNotes.push(`Task compliance has been trending <span class="caution-status font-semibold">DOWN (${currentAvgCompliance}%)</span> this week. Follow up is advised.`);
                } else {
                    detailedNotes.push(`Task compliance is consistently strong (${currentAvgCompliance}%).`);
                }
                
                // Combine status and details
                
                const overallStatusLine = `<p class="text-xl font-medium mb-3">Dr. Jenkins' overall health ${primaryStatus}</p>`;
                
                const combinedDetails = `
                    <ul class="list-disc pl-5 mt-3 space-y-2 text-base">
                        <li>${detailedNotes.join('</li><li>')}</li>
                    </ul>
                `;
                
                const finalSummary = `
                    ${overallStatusLine}
                    <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Detailed Analysis:</h4>
                    ${combinedDetails}
                    <p class="text-sm mt-4 font-semibold text-gray-500">
                        Review the Balance Risk and Task Compliance charts for proactive intervention planning.
                    </p>
                `;
                
                healthSummaryEl.innerHTML = finalSummary;

                if (isManualRefresh) {
                    analysisStatusEl.classList.add('hidden');
                }
            }, isManualRefresh ? 1500 : 0); 
        }

        // --- Task Management Functions (Unchanged) ---

        /** Renders the list of tasks to the UI. */
        function renderTaskList() {
            taskListEl.innerHTML = ''; // Clear existing list
            let completedCount = 0;

            tasks.forEach(task => {
                const itemDiv = document.createElement('div');
                itemDiv.className = `task-item ${task.completed ? 'completed' : 'text-gray-700'}`;
                itemDiv.setAttribute('onclick', `toggleTaskCompletion(${task.id})`);

                // Checkbox SVG (using Tailwind styles for color)
                const checkIcon = task.completed
                    ? `<svg class="w-6 h-6 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>` // Checked circle
                    : `<svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`; // Empty circle (same icon, different color/style)
                
                itemDiv.innerHTML = `
                    <div class="mr-3">${checkIcon}</div>
                    <span class="text-base font-medium">${task.text}</span>
                `;
                taskListEl.appendChild(itemDiv);

                if (task.completed) {
                    completedCount++;
                }
            });

            // Update Task Count Header
            taskCountEl.textContent = `${completedCount}/${tasks.length} Done`;
        }

        /** Toggles the completion status of a task by ID. */
        function toggleTaskCompletion(id) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                renderTaskList();
            }
        }

        /** Handles adding a new task from the form. */
        function addTask(event) {
            event.preventDefault(); // Prevent form submission
            const input = document.getElementById('new-task-input');
            const taskText = input.value.trim();

            if (taskText) {
                const newId = tasks.length > 0 ? Math.max(...tasks.map(t => t.id)) + 1 : 1;
                tasks.push({
                    id: newId,
                    text: taskText,
                    completed: false
                });
                input.value = ''; // Clear input
                renderTaskList();
            }
        }


        // --- Detailed Trend Chart Functions (UPDATED) ---
        
        /**
         * Generates and displays a detailed 24-hour trend chart for a given metric.
         * @param {string} metricType - 'hr', 'spo2', 'steps', or 'sleep'.
         */
        function showTrendDetail(metricType) {
            let title = "";
            let unit = "";
            let data = [];
            let color = 'var(--primary)';
            let min = null;
            let max = null;
            let pointRadius = 3; // Slightly larger points for line visibility
            let fill = false; // <<< CHANGE: Set fill to false for line graph
            const labels = Array.from({ length: 24 }, (_, i) => {
                const h = (i % 12) || 12;
                const ampm = i < 12 ? 'AM' : 'PM';
                return `${h}${ampm}`;
            });

            switch (metricType) {
                case 'hr':
                    title = "Heart Rate Trend (Last 24 Hours)";
                    unit = "BPM";
                    color = 'var(--primary)';
                    min = 55; max = 95;
                    data = Array.from({ length: 24 }, () => Math.floor(Math.random() * 21) + 60);
                    break;
                case 'spo2':
                    title = "Blood Oxygen Trend (Last 24 Hours)";
                    unit = "%";
                    color = 'var(--secondary)';
                    min = 90; max = 100;
                    data = Array.from({ length: 24 }, () => Math.floor(Math.random() * 6) + 94);
                    break;
                case 'steps':
                    title = "Activity Trend (Last 24 Hours)";
                    unit = "Steps";
                    color = 'var(--warning)';
                    min = 0; max = 500;
                    data = Array.from({ length: 24 }, (_, i) => {
                        if (i >= 8 && i <= 18) { 
                            return Math.floor(Math.random() * 300) + 50; 
                        }
                        return Math.floor(Math.random() * 30); 
                    });
                    break;
                case 'sleep':
                    title = "Sleep Activity Trend (Last 24 Hours)";
                    unit = "Activity Score (0-1)";
                    color = 'var(--danger)';
                    min = 0; max = 1;
                    data = Array.from({ length: 24 }, (_, i) => {
                        if (i >= 22 || i <= 6) {
                            return (Math.random() * 0.4) + 0.6; 
                        }
                        return Math.random() * 0.2; 
                    });
                    pointRadius = 0; 
                    break;
                default:
                    return;
            }

            const chartId = 'vitalsDetailChart';
            
            const modalContent = `
                <div class="w-full h-80">
                    <canvas id="${chartId}"></canvas>
                </div>
            `;

            showModalMessage(title, modalContent, true);
            
            setTimeout(() => {
                const ctx = document.getElementById(chartId)?.getContext('2d');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: `Hourly Average ${unit}`,
                                data: data,
                                borderColor: color, 
                                // REMOVED: backgroundColor property
                                borderWidth: 3, // Slightly thicker line
                                tension: 0.4, 
                                fill: fill, // <<< KEY CHANGE: Set to false
                                pointRadius: pointRadius,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { beginAtZero: (metricType === 'steps' || metricType === 'sleep'), min: min, max: max, title: { display: true, text: unit } },
                                x: { grid: { display: false } }
                            }
                        }
                    });
                }
            }, 50); 
        }


        // --- Mock Data and Vitals Update (Unchanged for core vitals) ---

        function updateVitals() {
            // Simulate minor fluctuations in core data
            currentHr = 70 + Math.floor(Math.random() * 8); 
            currentSpo2 = 95 + Math.floor(Math.random() * 4); // 95-98
            currentSteps = 1500 + Math.floor(Math.random() * 100);
            currentSleep = (7.0 + Math.random() * 0.5).toFixed(1);

            // Caregiver Metrics
            currentAdherence = 80 + Math.floor(Math.random() * 20); // 80-99%
            currentGaitRisk = 50 + Math.floor(Math.random() * 35); // 50-84 (Lower is better)

            
            hrValueEl.textContent = currentHr;
            spo2ValueEl.textContent = `${currentSpo2}%`;
            document.getElementById('steps-value').textContent = currentSteps.toLocaleString();
            document.getElementById('sleep-value').textContent = `${currentSleep}h`;
            adherenceTimeEl.textContent = `${currentAdherence}%`;
            gaitRiskEl.textContent = currentGaitRisk;
            
            // --- Update Gait Risk Progress Bar and Status ---
            gaitRiskBarEl.style.width = `${currentGaitRisk}%`;
            gaitRiskEl.classList.remove('safe-status', 'caution-status', 'critical-status');
            gaitRiskBarEl.classList.remove('progress-safe', 'progress-caution', 'progress-critical');

            let riskText = 'Low Risk (Excellent)';
            if (currentGaitRisk > 85) {
                gaitRiskEl.classList.add('critical-status');
                gaitRiskBarEl.classList.add('progress-critical');
                riskText = 'Critical Risk (Urgent Action)';
            } else if (currentGaitRisk > 65) {
                gaitRiskEl.classList.add('caution-status');
                gaitRiskBarEl.classList.add('progress-caution');
                riskText = 'Moderate Risk (Monitor closely)';
            } else {
                gaitRiskEl.classList.add('safe-status');
                gaitRiskBarEl.classList.add('progress-safe');
            }
            gaitRiskLabelEl.textContent = `Current: ${riskText}`;

            // Adherence: <85% is Caution
            adherenceTimeEl.classList.remove('safe-status', 'caution-status');
            if (currentAdherence < 85) {
                adherenceTimeEl.classList.add('caution-status');
            } else {
                adherenceTimeEl.classList.add('safe-status');
            }
            
            // --- Update Vitals Status Labels ---
            // HR Status
            hrStatusEl.textContent = currentHr < 60 ? 'Low (Bradycardia)' : (currentHr > 90 ? 'High (Tachycardia)' : 'Stable');
            hrStatusEl.className = `text-sm text-gray-500 mt-1 ${currentHr > 90 || currentHr < 60 ? 'caution-status' : 'safe-status'}`;
            
            // SpO2 Status
            spo2StatusEl.textContent = currentSpo2 < 94 ? 'Low Alert' : 'Optimal';
            spo2StatusEl.className = `text-sm text-gray-500 mt-1 ${currentSpo2 < 95 ? 'critical-status' : 'safe-status'}`;
            
            // Steps Status
            stepsStatusEl.textContent = currentSteps < 1000 ? 'Very low activity' : (currentSteps < 2000 ? 'Moderate activity' : 'Good activity');
            stepsStatusEl.className = `text-sm text-gray-500 mt-1 ${currentSteps < 1000 ? 'caution-status' : 'text-gray-500'}`;

            // Sleep Status
            sleepStatusEl.textContent = currentSleep < 6.5 ? 'Poor duration' : 'Good duration';
            sleepStatusEl.className = `text-sm text-gray-500 mt-1 ${currentSleep < 6.5 ? 'caution-status' : 'safe-status'}`;

            // Trigger critical alert for low SpO2
            if (currentSpo2 < 95) {
                 urgentAlertEl.classList.remove('hidden');
                 document.getElementById('alert-message').textContent = `CRITICAL: SpO₂ at ${currentSpo2}%. Check user immediately.`;
            } else {
                 urgentAlertEl.classList.add('hidden');
            }

            // Update Summary (only if not currently analyzing)
            if (analysisStatusEl.classList.contains('hidden')) {
                generateHealthSummary(false);
            }
            
            lastUpdateEl.textContent = new Date().toLocaleTimeString();
        }

        // --- Chart Rendering Functions (Weekly Aggregates, Unchanged) ---
        
        function generateMockHrData() {
            const data = [];
            for (let i = 0; i < 7; i++) {
                data.push(Math.floor(Math.random() * 21) + 65); // 65-85 BPM
            }
            return data;
        }

        function generateMockComplianceData() {
            const data = [];
            let sum = 0;
            for (let i = 0; i < 7; i++) {
                const compliance = Math.floor(Math.random() * 31) + 70; // 70-100%
                data.push(compliance);
                sum += compliance;
            }
            // Update the global compliance average for the summary
            currentAvgCompliance = Math.round(sum / 7); 
            return data;
        }

        function renderCharts() {
            const labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

            // HR Chart (Weekly Aggregate)
            const hrCtx = document.getElementById('hrChart').getContext('2d');
            const heartRateData = generateMockHrData();

            if (hrChart) hrChart.destroy(); 
            hrChart = new Chart(hrCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Average Daily BPM',
                        data: heartRateData,
                        borderColor: 'var(--primary)', 
                        backgroundColor: 'rgba(67, 56, 202, 0.1)',
                        borderWidth: 3,
                        tension: 0.3, 
                        fill: true,
                        pointRadius: 4,
                        pointBackgroundColor: 'var(--primary)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: false, min: 60, max: 90, title: { display: true, text: 'Heart Rate (BPM)' } },
                        x: { grid: { display: false } }
                    }
                }
            });

            // Compliance Chart (Weekly Aggregate)
            const compCtx = document.getElementById('complianceChart').getContext('2d');
            const complianceData = generateMockComplianceData();

            if (complianceChart) complianceChart.destroy(); 
            complianceChart = new Chart(compCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Task Compliance (%)',
                        data: complianceData,
                        backgroundColor: (context) => {
                            const value = context.parsed.y;
                            if (value < 80) return 'var(--danger)'; // Red for low compliance
                            if (value < 90) return 'var(--warning)'; // Amber for moderate
                            return 'var(--secondary)'; // Green for high
                        },
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, min: 60, max: 100, title: { display: true, text: 'Compliance (%)' } },
                        x: { grid: { display: false } }
                    }
                }
            });
            
            // Re-run summary after compliance is calculated
            if (analysisStatusEl.classList.contains('hidden')) {
                generateHealthSummary(false);
            }
        }
        
        // --- Initialization ---

        window.onload = function() {
            // Set up task form listener
            document.getElementById('add-task-form').addEventListener('submit', addTask);
            
            // Initial render of data
            updateVitals();
            renderCharts(); 
            renderTaskList();
            
            // Periodic updates
            setInterval(updateVitals, 5000); 
            setInterval(renderCharts, 30000); 
        };
        
    </script>
</body>
</html>